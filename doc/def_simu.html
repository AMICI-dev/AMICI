<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>AMICI: Model Definition &amp; Simulation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AMICI
   </div>
   <div id="projectbrief">A Matlab Interface for CVODES and IDAS</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('def_simu.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Model Definition &amp; Simulation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In the following we will give a detailed overview how to specify models in AMIWRAP and how to call the generated simulation files.</p>
<h1><a class="anchor" id="definition"></a>
Model Definition</h1>
<p>This guide will guide the user on how to specify models in MATLAB. For example implementations see the examples in the example directory.</p>
<h2><a class="anchor" id="header"></a>
Header</h2>
<p>The model definition needs to be defined as a function which returns a struct with all symbolic definitions and options.</p>
<div class="fragment"><div class="line"><span class="keyword">function</span> [model] = example_model_syms() </div>
</div><!-- fragment --><h2><a class="anchor" id="options"></a>
Options</h2>
<p>Set the options by specifying the respective field of the modelstruct</p>
<div class="fragment"><div class="line">model.(fieldname) = (value) </div>
</div><!-- fragment --><p>The options specify default options for simulation, parametrisation and compilation. All of these options are optional.</p>
<table class="doxtable">
<tr>
<th>field </th><th>description </th><th>default  </th></tr>
<tr>
<td>.atol </td><td>absolute integration tolerance </td><td>1e-8 </td></tr>
<tr>
<td>.rtol </td><td>relative integration tolerance </td><td>1e-8 </td></tr>
<tr>
<td>.maxsteps </td><td>maximal number integration steps </td><td>1e-8 </td></tr>
<tr>
<td>.param </td><td>parametrisation 'log'/'log10'/'lin' </td><td>'lin' </td></tr>
<tr>
<td>.debug </td><td>flag to compile with debug symbols </td><td>false </td></tr>
<tr>
<td>.forward </td><td>flag to activate forward sensitivities </td><td>true </td></tr>
<tr>
<td>.adjoint </td><td>flag to activate adjoint sensitivities </td><td>true </td></tr>
</table>
<p>When set to true, the fields 'noforward' and 'noadjoint' will speed up the time required to compile the model but also disable the respective sensitivity computation.</p>
<h2><a class="anchor" id="states"></a>
States</h2>
<p>Create the respective symbolic variables. The name of the symbolic variable can be chosen arbitrarily.</p>
<div class="fragment"><div class="line">syms state1 state2 state3 </div>
</div><!-- fragment --><p>Create the state vector containing all states:</p>
<div class="fragment"><div class="line">x = [ state1 state2 state3 ]; </div>
</div><!-- fragment --><h2><a class="anchor" id="parameters"></a>
Parameters</h2>
<p>Create the respective symbolic variables. The name of the symbolic variable can be chosen arbitrarily. Sensitivities <b>will be derived</b> for all paramaters.</p>
<div class="fragment"><div class="line">syms param1 param2 param3 param4 param5 param6 </div>
</div><!-- fragment --><p>Create the parameters vector</p>
<div class="fragment"><div class="line">p = [ param1 param2 param3 param4 param5 param6 ]; </div>
</div><!-- fragment --><h2><a class="anchor" id="constants"></a>
Constants</h2>
<p>Create the respective symbolic variables. The name of the symbolic variable can be chosen arbitrarily. Sensitivities with respect to constants <b>will not be derived</b>.</p>
<div class="fragment"><div class="line">syms const1 const2 </div>
</div><!-- fragment --><p>Create the parameters vector</p>
<div class="fragment"><div class="line">k = [ const1 const2 ]; </div>
</div><!-- fragment --><h2><a class="anchor" id="rhs"></a>
Differential Equation</h2>
<p>For time-dependent differential equations you can specify a symbolic variable for time. This <b>needs</b> to be denoted by t.</p>
<div class="fragment"><div class="line">syms t </div>
</div><!-- fragment --><p>Specify the right hand side of the differential equation f or xdot</p>
<div class="fragment"><div class="line">xdot(1) = [ const1 - param1*state1 ];</div>
<div class="line">xdot(2) = [ +param2*x(1) + <a class="code" href="symbolic__functions_8c.html#a30a33546875b9dd1a63c29312b316f7e">dirac</a>(t-param3) - const2*x(2) ];</div>
<div class="line">xdot(3) = [ param4*x(2) ];</div>
</div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">f(1) = [ const1 - param1*state1 ];</div>
<div class="line">f(2) = [ +param2*x(1) + <a class="code" href="symbolic__functions_8c.html#a30a33546875b9dd1a63c29312b316f7e">dirac</a>(t-param3) - const2*x(2) ];</div>
<div class="line">f(3) = [ 2*x(2) ];</div>
</div><!-- fragment --><p>The specification of f or xdot may depend on <a class="el" href="def_simu.html#states">States</a>, <a class="el" href="def_simu.html#parameters">Parameters</a> and <a class="el" href="def_simu.html#constants">Constants</a>.</p>
<p>For DAEs also specify the mass matrix.</p>
<div class="fragment"><div class="line">M = [1, 0, 0;...</div>
<div class="line">0, 1, 0;...</div>
<div class="line">0, 0, 0];</div>
</div><!-- fragment --><p>The specification of M may depend on parameters and constants.</p>
<p>For ODEs the integrator will solve the equation <img class="formulaInl" alt="$ \dot{x} = f $" src="form_0.png"/> and for DAEs the equations <img class="formulaInl" alt="$ M \cdot \dot{x} = f $" src="form_1.png"/>. AMICI will decide whether to use CVODES (for ODEs) or IDAS (for DAEs) based on whether the mass matrix is defined or not.</p>
<p>In the definition of the differential equation you can use certain symbolic functions. For a full list of available functions see <a class="el" href="symbolic__functions_8c.html" title="definition of symbolic functions ">symbolic_functions.c</a>.</p>
<p>Dirac functions can be used to cause a jump in the respective states at the specified time-point. This is typically used to model injections, or other external stimuli. Spline functions can be used to model time/state dependent response with unkown time/state dependence.</p>
<h2><a class="anchor" id="init"></a>
Initial Conditions</h2>
<p>Specify the initial conditions. These may depend on <a class="el" href="def_simu.html#parameters">Parameters</a> on <a class="el" href="def_simu.html#constants">Constants</a> and must have the same size as x.</p>
<div class="fragment"><div class="line">x0 = [ param4, 0, 0 ]; </div>
</div><!-- fragment --><h2><a class="anchor" id="observables"></a>
Observables</h2>
<p>Specify the observables. These may depend on <a class="el" href="def_simu.html#parameters">Parameters</a> and <a class="el" href="def_simu.html#constants">Constants</a>.</p>
<div class="fragment"><div class="line">y(1) = state1 + state2;</div>
<div class="line">y(2) = state3 - state2;</div>
</div><!-- fragment --><p>In the definition of the observable you can use certain symbolic functions. For a full list of available functions see <a class="el" href="symbolic__functions_8c.html" title="definition of symbolic functions ">symbolic_functions.c</a>. Dirac functions in observables will have no effect.</p>
<h2><a class="anchor" id="events"></a>
Events</h2>
<p>Specifying events is optional. Events are specified in terms of a root function. Events are defined to happen at the roots of the root function.</p>
<div class="fragment"><div class="line">root(1) = state1 - state2; </div>
</div><!-- fragment --><p>Events may depend on <a class="el" href="def_simu.html#states">States</a>, <a class="el" href="def_simu.html#parameters">Parameters</a> and <a class="el" href="def_simu.html#constants">Constants</a> but <b>not</b> on <a class="el" href="def_simu.html#observables">Observables</a></p>
<h2><a class="anchor" id="std"></a>
Standard Deviation</h2>
<p>Specifying of standard deviations is optional. It only has an effect when computing adjoint sensitivities. It allows the user to specify standard deviations of experimental data for <a class="el" href="def_simu.html#observables">Observables</a> and <a class="el" href="def_simu.html#events">Events</a>.</p>
<p>Standard deviaton for observable data is denoted by sigma_y</p>
<div class="fragment"><div class="line">sigma_y(1) = param5; </div>
</div><!-- fragment --><p>Standard deviaton for event data is denoted by sigma_y</p>
<div class="fragment"><div class="line">sigma_t(1) = param6; </div>
</div><!-- fragment --><p>Both sigma_y and sigma_t can either be a scalar or of the same dimension as the <a class="el" href="def_simu.html#observables">Observables</a> / <a class="el" href="def_simu.html#events">Events</a> function. They can depend on time and <a class="el" href="def_simu.html#parameters">Parameters</a> but must not depend on the <a class="el" href="def_simu.html#states">States</a> or <a class="el" href="def_simu.html#observables">Observables</a>. The values provided in sigma_y and sigma_t will only be used if the value in Sigma_Y or Sigma_T in the user-provided data struct is NaN. See <a class="el" href="def_simu.html#simulation">Model Simulation</a> for details.</p>
<h2><a class="anchor" id="attach"></a>
Attach to Model Struct</h2>
<p>Eventually all symbolic expressions need to be attached to the model struct.</p>
<div class="fragment"><div class="line">model.sym.x = x;</div>
<div class="line">model.sym.k = k;</div>
<div class="line">model.sym.root = root;</div>
<div class="line">model.sym.xdot = xdot;</div>
<div class="line">% or</div>
<div class="line">model.sym.f = f;</div>
<div class="line">model.sym.M = M; %only <span class="keywordflow">for</span> DAEs</div>
<div class="line">model.sym.p = p;</div>
<div class="line">model.sym.x0 = x0;</div>
<div class="line">model.sym.y = y;</div>
<div class="line">model.sym.sigma_y = sigma_y;</div>
<div class="line">model.sym.sigma_t = sigma_t;</div>
</div><!-- fragment --><h1><a class="anchor" id="compilation"></a>
Model Compilation</h1>
<p>The model can then be compiled by calling amiwrap:</p>
<div class="fragment"><div class="line"><a class="code" href="amiwrap_8m.html#a183dd11adc4bd525147faa2590ea325b">amiwrap</a>(modelname,<span class="stringliteral">&#39;example_model_syms&#39;</span>,dir,o2flag)</div>
</div><!-- fragment --><p>Here modelname should be a string defining the modelname, dir should be a string containing the path to the directory in which simulation files should be placed and o2flag is a flag indicating whether second order sensitivities should also be compiled. The user should make sure that the previously defined function 'example_model_syms' is in the user path. Alternatively, the user can also call the function 'example_model_syms'</p>
<div class="fragment"><div class="line">[model] = example_model_syms() </div>
</div><!-- fragment --><p>and subsequently provide the generated struct to <a class="el" href="amiwrap_8m.html#a183dd11adc4bd525147faa2590ea325b" title="AMIWRAP generates c mex files for the simulation of systems of differential equations via CVODES and ...">amiwrap()</a>, instead of providing the symbolic function:</p>
<div class="fragment"><div class="line"><a class="code" href="amiwrap_8m.html#a183dd11adc4bd525147faa2590ea325b">amiwrap</a>(modelname,model,dir,o2flag)</div>
</div><!-- fragment --><p>In a similar fashion, the user could also generate multiple model and pass them directly to <a class="el" href="amiwrap_8m.html#a183dd11adc4bd525147faa2590ea325b" title="AMIWRAP generates c mex files for the simulation of systems of differential equations via CVODES and ...">amiwrap()</a> without generating respective model definition scripts.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="amiwrap_8m.html#a183dd11adc4bd525147faa2590ea325b" title="AMIWRAP generates c mex files for the simulation of systems of differential equations via CVODES and ...">amiwrap()</a></dd></dl>
<h1><a class="anchor" id="simulation"></a>
Model Simulation</h1>
<p>After the call to <a class="el" href="amiwrap_8m.html#a183dd11adc4bd525147faa2590ea325b" title="AMIWRAP generates c mex files for the simulation of systems of differential equations via CVODES and ...">amiwrap()</a> two files will be placed in the specified directory. One is a am_<em>modelname</em>.mex and the other is simulate_<em>modelname</em>.m. The mex file should never be called directly. Instead the MATLAB script, which acts as a wrapper around the .mex simulation file should be used.</p>
<p>The simulate_<em>modelname</em>.m itself carries extensive documentation on how to call the function, what it returns and what additional options can be specified. In the following we will give a short overview of possible function calls.</p>
<h2><a class="anchor" id="integration"></a>
Integration</h2>
<p>Define a time vector:</p>
<div class="fragment"><div class="line">t = linspace(0,10,100)</div>
</div><!-- fragment --><p>Generate a parameter vector:</p>
<div class="fragment"><div class="line">theta = ones(6,1);</div>
</div><!-- fragment --><p>Generate a constants vector:</p>
<div class="fragment"><div class="line">kappa = ones(2,1);</div>
</div><!-- fragment --><p>Integrate:</p>
<div class="fragment"><div class="line">sol = simulate_modelname(t,theta,kappa,[],options)</div>
</div><!-- fragment --><p>The integration status will be indicated by the sol.status flag. Negative values indicated failed integration. The states will then be available as sol.x. The observables will then be available as sol.y. The events will then be available as sol.root. If no event occured there will be an event at the end of the considered interval with the final value of the root function stored in sol.rval.</p>
<p>Alternatively the integration call also be called via</p>
<div class="fragment"><div class="line">[status,t,x,y] = simulate_modelname(t,theta,kappa,[],options)</div>
</div><!-- fragment --><p>The integration status will be indicated by the status flag. Negative values indicated failed integration. The states will then be available as x. The observables will then be available as y. No event output will be given.</p>
<h2><a class="anchor" id="forward"></a>
Forward Sensitivities</h2>
<p>Define a time vector:</p>
<div class="fragment"><div class="line">t = linspace(0,10,100)</div>
</div><!-- fragment --><p>Generate a parameter vector:</p>
<div class="fragment"><div class="line">theta = ones(6,1);</div>
</div><!-- fragment --><p>Generate a constants vector:</p>
<div class="fragment"><div class="line">kappa = ones(2,1);</div>
</div><!-- fragment --><p>Set the sensitivity computation to forward sensitivities and Integrate:</p>
<div class="fragment"><div class="line">options.sensi = 1;</div>
<div class="line">options.forward = <span class="keyword">true</span>;</div>
<div class="line">sol = simulate_modelname(t,theta,kappa,[],options)</div>
</div><!-- fragment --><p>The integration status will be indicated by the sol.status flag. Negative values indicated failed integration. The states will then be available as sol.x, with the derivative with respect to the parameters in sol.sx. The observables will then be available as sol.y, with the derivative with respect to the parameters in sol.sy. The events will then be available as sol.root, with the derivative with respect to the parameters in sol.sroot. If no event occured there will be an event at the end of the considered interval with the final value of the root function stored in sol.rootval, with the derivative with respect to the parameters in sol.srootval</p>
<p>Alternatively the integration call also be called via</p>
<div class="fragment"><div class="line">[status,t,x,y,sx,sy] = simulate_modelname(t,theta,kappa,[],options)</div>
</div><!-- fragment --><p>The integration status will be indicated by the status flag. Negative values indicated failed integration. The states will then be available as x, with derivative with respect to the parameters in sx. The observables will then be available as y, with derivative with respect to the parameters in sy. No event output will be given.</p>
<h2><a class="anchor" id="adjoint"></a>
Adjoint Sensitivities</h2>
<p>Define a time vector:</p>
<div class="fragment"><div class="line">t = linspace(0,10,100)</div>
</div><!-- fragment --><p>Generate a parameter vector:</p>
<div class="fragment"><div class="line">theta = ones(6,1);</div>
</div><!-- fragment --><p>Set the sensitivity computation to adjoint sensitivities:</p>
<div class="fragment"><div class="line">options.sensi = 1;</div>
<div class="line">options.adjoint = <span class="keyword">true</span>;</div>
</div><!-- fragment --><p>Define Experimental Data:</p>
<div class="fragment"><div class="line">D.Y = [NaN(1,2)],ones(length(t)-1,2)];</div>
<div class="line">D.Sigma_Y = [0.1*ones(length(t)-1,2),NaN(1,2)];</div>
<div class="line">D.T = ones(1,1);</div>
<div class="line">D.Sigma_T = NaN;</div>
</div><!-- fragment --><p>The NaN values in Sigma_Y and Sigma_T will be replaced by the specification in <a class="el" href="def_simu.html#std">Standard Deviation</a>. Data points with NaN value will be completely ignored.</p>
<p>Generate a constants vector:</p>
<div class="fragment"><div class="line">kappa = ones(2,1);</div>
</div><!-- fragment --><p>Integrate:</p>
<div class="fragment"><div class="line">sol = simulate_modelname(t,theta,kappa,D,options)</div>
</div><!-- fragment --><p>The integration status will be indicated by the sol.status flag. Negative values indicated failed integration. The log-likelihood will then be available as sol.llh and the derivative with respect to the parameters in sol.sllh. Notice that for adjoint sensitivities no state, observable and event sensitivities will be available. Yet this approach can be expected to be significantly faster for systems with a large number of parameters.</p>
<h2><a class="anchor" id="steadystate"></a>
Steady State Sensitivities</h2>
<p>This will compute state sensitivities according to the formula <img class="formulaInl" alt="$ s_k^x = -\left(\frac{\partial f}{\partial x} \right)^{-1}\frac{\partial f}{\partial \theta_k} $" src="form_2.png"/></p>
<p>In the current implementation this formulation does not allow for conservation laws as this would result in a singular Jacobian.</p>
<p>Define a final timepoint t:</p>
<div class="fragment"><div class="line">t = 100</div>
</div><!-- fragment --><p>Generate a parameter vector:</p>
<div class="fragment"><div class="line">theta = ones(6,1);</div>
</div><!-- fragment --><p>Generate a constants vector:</p>
<div class="fragment"><div class="line">kappa = ones(2,1);</div>
</div><!-- fragment --><p>Set the sensitivity computation to steady state sensitivities:</p>
<div class="fragment"><div class="line">options.sensi = 1;</div>
<div class="line">options.ss = 1;</div>
</div><!-- fragment --><p>Integrate:</p>
<div class="fragment"><div class="line">sol = simulate_modelname(t,theta,kappa,D,options)</div>
</div><!-- fragment --><p>The states will then be available as sol.x, with the derivative with respect to the parameters in sol.sx. The observables will then be available as sol.y, with the derivative with respect to the parameters in sol.sy. Notice that for steady state sensitivities no event sensitivities will be available. For the accuracy of the computed derivatives it is essential that the system is sufficiently close to a steady state. This can be checked by examining the right hand side of the system at the final time-point via sol.xdot. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Nov 9 2015 16:42:40 for AMICI by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
