# ---------------------------------------------------------------
# Programmer:  Cody J. Balos @ LLNL
# ---------------------------------------------------------------
# LLNS Copyright Start
# Copyright (c) 2017, Lawrence Livermore National Security
# This work was performed under the auspices of the U.S. Department
# of Energy by Lawrence Livermore National Laboratory in part under
# Contract W-7405-Eng-48 and in part under Contract DE-AC52-07NA27344.
# Produced at the Lawrence Livermore National Laboratory.
# All rights reserved.
# For details, see the LICENSE file.
# LLNS Copyright End
# ---------------------------------------------------------------
# CMakeLists.txt file for the F2003 CVODE object library

set(cvode_SOURCES fcvode.f90)

# Add variable nvec_SOURCES with the common NVECTOR sources which will
# also be included in the CVODE library
set(nvec_SOURCES
  ${sundials_SOURCE_DIR}/src/nvec_ser/F90/fnvector_serial.f90
)

# Add variable sunmatrix_SOURCES with the common SUNMatrix sources which will
# also be included in the CVODE library
set(sunmatrix_SOURCES
  ${sundials_SOURCE_DIR}/src/sunmat_band/F90/fsunmatrix_band.f90
  ${sundials_SOURCE_DIR}/src/sunmat_dense/F90/fsunmatrix_dense.f90
  ${sundials_SOURCE_DIR}/src/sunmat_sparse/F90/fsunmatrix_sparse.f90
)

# Add variable sunlinsol_SOURCES with the common SUNLinearSolver sources which will
# also be included in the CVODE library
set(sunlinsol_SOURCES
  ${sundials_SOURCE_DIR}/src/sunlinsol_band/F90/fsunlinsol_band.f90
  ${sundials_SOURCE_DIR}/src/sunlinsol_dense/F90/fsunlinsol_dense.f90
  ${sundials_SOURCE_DIR}/src/sunlinsol_spbcgs/F90/fsunlinsol_spbcgs.f90
  ${sundials_SOURCE_DIR}/src/sunlinsol_spfgmr/F90/fsunlinsol_spfgmr.f90
  ${sundials_SOURCE_DIR}/src/sunlinsol_spgmr/F90/fsunlinsol_spgmr.f90
  ${sundials_SOURCE_DIR}/src/sunlinsol_sptfqmr/F90/fsunlinsol_sptfqmr.f90
  ${sundials_SOURCE_DIR}/src/sunlinsol_pcg/F90/fsunlinsol_pcg.f90
)

# Add variable sunnonlinsol_SOURCES with the common SUNNonlinearSolver sources
# which will also be included in the CVODE library
set(sunnonlinsol_SOURCES
  ${sundials_SOURCE_DIR}/src/sunnonlinsol/newton/F90/fsunnonlinsol_newton.f90
  ${sundials_SOURCE_DIR}/src/sunnonlinsol/fixedpoint/F90/fsunnonlinsol_fixedpoint.f90
)

# Set the Fortran module directory to a temporary location.
# We do this to avoid naming collisions in parallel builds (make -j).
# The .mod files generated when building the fcvode_mod library are
# duplicates of the .mod files generated by the SUNDIALS modules themselves.
# As such, we do not need to keep them around.
set(CMAKE_Fortran_MODULE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/CMakeFiles/tmp)

if(BUILD_STATIC_LIBS)
  sundials_add_f2003_interface_library(sundials_fcvode_mod_static STATIC
    ${cvode_SOURCES}
    ${nvec_SOURCES}
    ${sunmatrix_SOURCES}
    ${sunlinsol_SOURCES}
    ${sunnonlinsol_SOURCES}
  )

  # include the directoy where the .mod files reside
  target_include_directories(sundials_fcvode_mod_static
    PUBLIC
      $<BUILD_INTERFACE:${CMAKE_Fortran_MODULE_DIRECTORY}_STATIC>
      $<INSTALL_INTERFACE:${Fortran_INSTALL_MODDIR}>
  )

  # Set the library name and make sure it is not deleted
  set_target_properties(sundials_fcvode_mod_static
    PROPERTIES OUTPUT_NAME sundials_fcvode_mod CLEAN_DIRECT_OUTPUT 1)

  # install the library
  install(TARGETS sundials_fcvode_mod_static DESTINATION ${CMAKE_INSTALL_LIBDIR})

  # install the cvode mod file from here since it won't go into the
  # top level fortran mod file directory
  install(FILES ${CMAKE_Fortran_MODULE_DIRECTORY}_STATIC/fcvode_mod.mod
          DESTINATION ${Fortran_INSTALL_MODDIR})
endif()

if(BUILD_SHARED_LIBS)
  sundials_add_f2003_interface_library(sundials_fcvode_mod_shared SHARED
    ${cvode_SOURCES}
    ${nvec_SOURCES}
    ${sunmatrix_SOURCES}
    ${sunlinsol_SOURCES}
    ${sunnonlinsol_SOURCES}
  )

  # include the directoy where the .mod files reside
  target_include_directories(sundials_fcvode_mod_shared
    PUBLIC
      $<BUILD_INTERFACE:${CMAKE_Fortran_MODULE_DIRECTORY}_SHARED>
      $<INSTALL_INTERFACE:${Fortran_INSTALL_MODDIR}>
  )

  # Set the library name and make sure it is not deleted
  set_target_properties(sundials_fcvode_mod_shared
    PROPERTIES OUTPUT_NAME sundials_fcvode_mod CLEAN_DIRECT_OUTPUT 1)

  # install the library
  install(TARGETS sundials_fcvode_mod_shared DESTINATION ${CMAKE_INSTALL_LIBDIR})

  # install the cvode mod file from here since it won't go into the
  # top level fortran mod file directory
  install(FILES ${CMAKE_Fortran_MODULE_DIRECTORY}_SHARED/fcvode_mod.mod
          DESTINATION ${Fortran_INSTALL_MODDIR})
endif()

message(STATUS "Added CVODE F2003 interface")
